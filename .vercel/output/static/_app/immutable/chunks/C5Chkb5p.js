import{w as f,d as u}from"./DMUzB5DZ.js";import{s}from"./BsE10o59.js";class i{static async signUp(r){try{const{data:e,error:o}=await s.auth.signUp({email:r.email,password:r.password,options:{data:{name:r.name||"Neuer Nutzer"}}});if(o)throw o;return{data:e,error:null}}catch(e){return console.error("âŒ Sign up error:",e),{data:null,error:e}}}static async signIn(r){try{const{data:e,error:o}=await s.auth.signInWithPassword({email:r.email,password:r.password});if(o)throw o;return{data:e,error:null}}catch(e){return console.error("âŒ Sign in error:",e),{data:null,error:e}}}static async signOut(){try{const{error:r}=await s.auth.signOut();if(r)throw r;return{error:null}}catch(r){return console.error("âŒ Sign out error:",r),{error:r}}}static async getSession(){try{const{data:r,error:e}=await s.auth.getSession();if(e)throw e;return{session:r.session,error:null}}catch(r){return console.error("âŒ Get session error:",r),{session:null,error:r}}}static async getUser(){try{const{data:r,error:e}=await s.auth.getUser();if(e)throw e;return{user:r.user,error:null}}catch(r){return console.error("âŒ Get user error:",r),{user:null,error:r}}}static async getProfile(r){try{const{data:e,error:o}=await s.from("profiles").select("*").eq("id",r).single();if(o)throw o;return{profile:e,error:null}}catch(e){return console.error("âŒ Get profile error:",e),{profile:null,error:e}}}static onAuthStateChange(r){return s.auth.onAuthStateChange(r)}}class d{static async hasProfile(r){try{const{data:e,error:o}=await s.from("profiles").select("id").eq("id",r).single();if(o){if(o.code==="PGRST116")return!1;throw o}return!!e}catch(e){return console.error("âŒ Error checking profile:",e),!1}}static async getProfile(r){try{const{data:e,error:o}=await s.from("profiles").select("*").eq("id",r).single();if(o)throw o;return{profile:e,error:null}}catch(e){return console.error("âŒ Error getting profile:",e),{profile:null,error:e}}}static async upsertProfile(r,e,o){try{const{error:a}=await s.from("profiles").upsert({id:r,name:e,goal:o||null,onboarding_completed:!0,data_consent:!0},{onConflict:"id"});if(a)throw a;return{success:!0,error:null}}catch(a){return console.error("âŒ Error upserting profile:",a),{success:!1,error:a}}}static async needsOnboarding(r){try{const{data:e,error:o}=await s.from("profiles").select("onboarding_completed").eq("id",r).single();if(o){if(o.code==="PGRST116")return!0;throw o}return!e.onboarding_completed}catch(e){return console.error("âŒ Error checking onboarding:",e),!0}}}const l={user:null,profile:null,session:null,loading:!0},n=f(l),h={subscribe:n.subscribe,async initialize(){n.update(r=>({...r,loading:!0}));const{session:t}=await i.getSession();if(t!=null&&t.user){const{profile:r}=await i.getProfile(t.user.id);n.set({user:t.user,profile:r,session:t,loading:!1})}else n.set({...l,loading:!1})},async signIn(t,r){const{data:e,error:o}=await i.signIn({email:t,password:r});if(o||!e)return{error:o};if(e.user){const{profile:a}=await i.getProfile(e.user.id),c=await d.needsOnboarding(e.user.id);return n.set({user:e.user,profile:a,session:e.session,loading:!1}),{error:null,needsOnboarding:c}}return{error:null}},async signUp(t,r,e){const{data:o,error:a}=await i.signUp({email:t,password:r,name:e});return a?{error:a}:{error:null,requiresEmailConfirmation:!0}},async signOut(){await i.signOut(),n.set(l)},setupAuthListener(){return i.onAuthStateChange(async(t,r)=>{if(console.log("ðŸ” Auth event:",t),t==="SIGNED_IN"&&(r!=null&&r.user)){const{profile:e}=await i.getProfile(r.user.id);n.set({user:r.user,profile:e,session:r,loading:!1})}else t==="SIGNED_OUT"&&n.set({...l,loading:!1})})}},w=u(n,t=>!!t.user),y=u(n,t=>t.user),m=u(n,t=>t.profile),b=u(n,t=>t.user&&t.profile&&!t.profile.onboarding_completed);export{d as P,h as a,m as b,y as c,w as i,b as n};
